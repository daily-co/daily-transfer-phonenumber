# üì¶ Daily.co Phone Number Transfer Utility

## Overview

This CLI utility safely transfers purchased phone numbers and their associated `pinless_dialin` configurations from one Daily.co domain to another. Bear in mind that the transfer should be done on a day when there are no calls in progress. **As the transfer will result in active calls to disconnect!** 

This is important for Daily.co customers [migrating from DailyBots to Pipecat Cloud](https://docs.pipecat.daily.co/pipecat-in-production/daily-bots-migration).

---

## Goals

- [x] List purchased phone numbers for a Daily domain
- [x] Allow user to select which numbers to transfer
- [x] Discover all related configs (including legacy and unnumbered SIP interconnects)
- [x] Build a full transfer plan in a dry-run/read-only phase
- [x] Sequentially transfer phone numbers and their configs
  - [x] deleting configs from source domain and recreating in the target domain

---

## Prerequisites

- Python 3.7+
- `pip install -r requirements.txt`
- `.env` file with `DAILY_SOURCE_API_KEY` and `DAILY_TARGET_API_KEY`

## Usage

Run:

```bash
python create-transfer-plan.py

# review transfer_plan.json, this was generated by create-transfer-plan.py
# you can edit transfer_plan.json 
# for example change `room_creation_api` to point to a new url
```

Example of a transfer plan:

```json
{
  "+10114870006": {
    "source_phone_id": "uuid",
    "src_type": "domain-dialin-config",
    "config_id": "uuid",
    "config_data": {
      "phone_number": "+10114870006",
      "sip_uri": "...",
      "hmac": "...",
      "room_creation_api": "https://example.com/api/dial",
      "name_prefix": "+10114870006",
      "type": "pinless_dialin"
    }
  }
}
```
Now you are ready to transfer the phone number

```bash
python transfer.py
```

If the dialin-config fails to be created, you have two choices:
1. Rollback, i.e., the phone number will be transferred back to the original account
2. do nothing, in this case, you will need to manually re-create the dialin-config in the new account

---

## Execution Model

1. **Phase 1 ‚Äî Discovery (Read-Only):**
   - Step 1: Fetch purchased phone numbers
   - Step 2: Prompt user to select numbers
   - Step 3: Discover associated `pinless_dialin`, `pin_dialin` and related configs (including ones without phone numbers)
   - Generate a `transfer_plan.json` structure summarizing everything that will be transferred

2. **Phase 2 ‚Äî Per-Number Transfer (Write):**
   - For each phone number:
     - Step 4: Transfer the phone number via Daily API
     - Step 5: Delete the old config in the source domain
     - Step 6: Recreate the config in the target domain

Deleting the dialin-configs in the source domain is required as the 
config wont be created in the target domain until it is deleted.

---

## API Usage

### üîç List Purchased Phone Numbers

```bash
curl --request GET \
  --url 'https://api.daily.co/v1/purchased-phone-numbers' \
  --header 'Authorization: Bearer <SOURCE_API_KEY>'
```

Response:

```json
{
  "total_count": 2,
  "data": [
    {
      "id": "aa197...",
      "number": "+1234567...",
      "name": "Dr. Nemo's office"
    },{
      "id": "bas123...",
      "number": "+1987654...",
      "name": "Dr. Smith's office"
    }
  ]
}
```

### üîç List Pin and Pinless Dial-in Configs

(a) Domain-level (legacy)

```bash
curl --request GET \
  --url 'https://api.daily.co/v1/' \
  --header 'Authorization: Bearer <SOURCE_API_KEY>'
```

Response, look inside: `config.pinless_dialin` and `config.pin_dialin`

```json
{
  "id": "8505...",
  "config": {
    "pinless_dialin": [{
            "phone_number": "...",
            "sip_uri": "...",
            "hmac": "...",
            "room_creation_api": "...",
            "name_prefix": "..."
        }, {
            "sip_uri": "...",
            "hmac": "...",
            "room_creation_api": "...",
            "name_prefix": "..."
        }   
    ]
  }
}
```

(b) Dialin Config API (modern)


```bash
curl --request GET \
  --url 'https://api.daily.co/v1/domain-dialin-config' \
  --header 'Authorization: Bearer <SOURCE_API_KEY>'
```

Response:

```json
{
  "id": "8505...",
  "type": "pinless_dialin",
  "config": {
    "phone_number": "+1234567...",
    "room_creation_api": "...",
    "name_prefix": "...",
    "hmac": "..."
  }
}   
```

### üì§ Transfer Phone Number

```bash
curl --request POST \
  --url 'https://api.daily.co/v1/transfer-phone-number/<PHONE_ID>' \
  --header 'Authorization: Bearer <SOURCE_API_KEY>' \
  --header 'Content-Type: application/json' \
  --data '{
    "transferDomainName": "<TARGET_DOMAIN_NAME>",
    "transferDomainApi": "<TARGET_API_KEY>"
  }'
```

Response:

```json
{
  "status": true,
  "newId": "cb44528c-..."  
}
``` 

### Delete dialin-config on source domain

Note: the config on the old domain needs to be deleted before the configs can be made on the new domain. However, the configs on the old domain need to be deleted only after the phone numbers have been transferred.

The config_id is found in the transfer_plan.json, it corresponds to the `id` associated to the phone number in the `domain-dialin-config` response.

```bash
curl -H "Content-Type: application/json" \
  -H "Authorization: Bearer $API_KEY" \
  -XDELETE \
  https://api.daily.co/v1/domain-dialin-config/:config_id

```

### Recreate dialin-config on target domain



```bash
curl --request POST \
  --url 'https://api.daily.co/v1/domain-dialin-config' \
  --header 'Authorization: Bearer <TARGET_API_KEY>' \
  --header 'Content-Type: application/json' \
  --data '{
    "type": "pinless_dialin",
    "config": {
      "phone_number": "+10114870006",
      "room_creation_api": "https://example.com/api/dial",
      "name_prefix": "+10114870006",
      "hmac": "...",
      "timeout_config": {
        "message": "No agent is available"
      }
    }
  }'        
  ```

  Note: Configs without phone numbers should also be migrated using this endpoint, omitting the `phone_number` field.
